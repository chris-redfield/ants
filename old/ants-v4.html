<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ant Colony Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a2e;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #e0e0e0;
            overflow: hidden;
        }

        header {
            padding: 15px 20px;
            text-align: center;
            background: linear-gradient(180deg, #1a1a2e 0%, transparent 100%);
            width: 100%;
            z-index: 10;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 300;
            letter-spacing: 3px;
            color: #f4a261;
            text-transform: uppercase;
        }

        .subtitle {
            font-size: 0.75rem;
            color: #888;
            margin-top: 5px;
            letter-spacing: 1px;
        }

        #game-container {
            position: relative;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        #canvas-wrapper {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 40px rgba(244, 162, 97, 0.1);
        }

        canvas {
            display: block;
        }

        #bg-canvas {
            background: #2d5a27;
        }

        #pheromone-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 2;
        }

        #ant-canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 3;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            z-index: 100;
            padding: 15px 20px;
            background: rgba(26, 26, 46, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(244, 162, 97, 0.2);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button {
            padding: 10px 20px;
            font-size: 0.85rem;
            border: 1px solid rgba(244, 162, 97, 0.3);
            border-radius: 6px;
            background: rgba(244, 162, 97, 0.1);
            color: #f4a261;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        button:hover {
            background: rgba(244, 162, 97, 0.2);
            border-color: #f4a261;
        }

        button:active {
            transform: scale(0.95);
        }

        button.active {
            background: rgba(244, 162, 97, 0.3);
            border-color: #f4a261;
        }

        input[type="range"] {
            width: 100px;
            accent-color: #f4a261;
        }

        .stats {
            position: fixed;
            top: 70px;
            left: 20px;
            font-size: 0.75rem;
            color: #666;
            line-height: 1.8;
            z-index: 100;
        }

        .stats span {
            color: #f4a261;
        }

        .legend {
            position: fixed;
            top: 70px;
            right: 20px;
            font-size: 0.7rem;
            color: #666;
            line-height: 2;
            z-index: 100;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .instructions {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #555;
            text-align: center;
            z-index: 50;
        }

        @media (max-width: 600px) {
            header {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.2rem;
            }

            .controls {
                bottom: 10px;
                padding: 10px 15px;
                gap: 8px;
            }

            button {
                padding: 8px 14px;
                font-size: 0.75rem;
            }

            input[type="range"] {
                width: 80px;
            }

            .stats, .legend {
                font-size: 0.65rem;
            }

            .instructions {
                bottom: 85px;
                font-size: 0.65rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üêú Ant Colony</h1>
        <div class="subtitle">Emergent Intelligence from Simple Rules</div>
    </header>

    <div id="game-container">
        <div id="canvas-wrapper">
            <canvas id="bg-canvas"></canvas>
            <canvas id="pheromone-canvas"></canvas>
            <canvas id="ant-canvas"></canvas>
        </div>
    </div>

    <div class="stats">
        <div>Ants: <span id="ant-count">0</span></div>
        <div>Food Collected: <span id="food-collected">0</span></div>
        <div>Food Sources: <span id="food-sources">0</span></div>
        <div>Colony Size: <span id="colony-size">1</span></div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #b08860, #6b4423);"></div>
            <span>Ant Hill</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #4ade80, #fbbf24, #f87171);"></div>
            <span>Food</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(77, 166, 255, 0.5);"></div>
            <span>Home Trail</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: rgba(255, 180, 50, 0.5);"></div>
            <span>Food Trail</span>
        </div>
    </div>

    <div class="instructions">Click to add food ‚Ä¢ Watch trails emerge</div>

    <div class="controls">
        <div class="control-group">
            <label>Ants</label>
            <input type="range" id="ant-slider" min="20" max="500" value="150">
        </div>
        <div class="control-group">
            <label>Speed</label>
            <input type="range" id="speed-slider" min="1" max="5" value="2">
        </div>
        <div class="control-group">
            <label>Food</label>
            <input type="range" id="food-slider" min="0" max="15" value="5">
        </div>
        <div class="control-group">
            <label>Trails</label>
            <button id="toggle-trails" class="active">On</button>
        </div>
        <div class="control-group">
            <label>Style</label>
            <button id="toggle-style" class="active">Ant</button>
        </div>
        <div class="control-group">
            <label>Reset</label>
            <button id="reset-btn">‚Ü∫</button>
        </div>
    </div>

    <script>
        // Canvas setup
        const bgCanvas = document.getElementById('bg-canvas');
        const pheromoneCanvas = document.getElementById('pheromone-canvas');
        const antCanvas = document.getElementById('ant-canvas');
        const bgCtx = bgCanvas.getContext('2d');
        const pheromoneCtx = pheromoneCanvas.getContext('2d');
        const antCtx = antCanvas.getContext('2d');

        // Size configuration
        let width, height;
        const CELL_SIZE = 4; // Pheromone grid cell size
        let gridWidth, gridHeight;

        // Simulation state
        let ants = [];
        let foods = [];
        let colony = { x: 0, y: 0, radius: 25, foodStored: 0 };
        let homePheromones = [];
        let foodPheromones = [];
        let showTrails = true;
        let simulationSpeed = 2;
        let targetAntCount = 150;
        let targetFoodCount = 5;
        let antStyle = 'classic'; // 'classic' or 'detailed'
        let colonyGranules = []; // Store granule positions so they don't move

        // Constants
        const ANT_SPEED = 2;
        const PHEROMONE_DEPOSIT = 100;
        const PHEROMONE_DECAY = 0.995;
        const PHEROMONE_DIFFUSE = 0.1;
        const WANDER_STRENGTH = 0.3;
        const PHEROMONE_FOLLOW_STRENGTH = 0.8;

        function resize() {
            const container = document.getElementById('game-container');
            const maxWidth = Math.min(container.clientWidth - 40, 900);
            const maxHeight = Math.min(container.clientHeight - 40, 700);
            
            width = Math.floor(maxWidth / CELL_SIZE) * CELL_SIZE;
            height = Math.floor(maxHeight / CELL_SIZE) * CELL_SIZE;
            
            gridWidth = Math.floor(width / CELL_SIZE);
            gridHeight = Math.floor(height / CELL_SIZE);

            [bgCanvas, pheromoneCanvas, antCanvas].forEach(canvas => {
                canvas.width = width;
                canvas.height = height;
            });

            // Initialize pheromone grids
            homePheromones = new Float32Array(gridWidth * gridHeight);
            foodPheromones = new Float32Array(gridWidth * gridHeight);

            // Set colony position
            colony.x = width / 2;
            colony.y = height / 2;

            drawBackground();
        }

        function drawBackground() {
            // Base grass color
            bgCtx.fillStyle = '#2d5a27';
            bgCtx.fillRect(0, 0, width, height);

            // Add grass texture - random darker/lighter patches
            for (let i = 0; i < 500; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const size = 2 + Math.random() * 8;
                const brightness = Math.random();
                
                if (brightness > 0.5) {
                    bgCtx.fillStyle = `rgba(60, 120, 50, ${0.1 + Math.random() * 0.2})`;
                } else {
                    bgCtx.fillStyle = `rgba(20, 60, 15, ${0.1 + Math.random() * 0.2})`;
                }
                bgCtx.beginPath();
                bgCtx.ellipse(x, y, size, size * 0.6, Math.random() * Math.PI, 0, Math.PI * 2);
                bgCtx.fill();
            }

            // Add some grass blade hints
            bgCtx.strokeStyle = 'rgba(45, 100, 35, 0.3)';
            bgCtx.lineWidth = 1;
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                const length = 5 + Math.random() * 10;
                const angle = -Math.PI/2 + (Math.random() - 0.5) * 0.5;
                
                bgCtx.beginPath();
                bgCtx.moveTo(x, y);
                bgCtx.lineTo(x + Math.cos(angle) * length, y + Math.sin(angle) * length);
                bgCtx.stroke();
            }
        }

        class Ant {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.angle = Math.random() * Math.PI * 2;
                this.hasFood = false;
                this.foodColor = null; // Color of food being carried
                this.pheromoneTimer = 0;
                this.wanderAngle = 0;
                this.distanceTraveled = 0;
                this.maxPheromoneStrength = PHEROMONE_DEPOSIT;
            }

            update() {
                // Deposit pheromones
                this.pheromoneTimer++;
                if (this.pheromoneTimer > 2) {
                    this.pheromoneTimer = 0;
                    const gx = Math.floor(this.x / CELL_SIZE);
                    const gy = Math.floor(this.y / CELL_SIZE);
                    if (gx >= 0 && gx < gridWidth && gy >= 0 && gy < gridHeight) {
                        const idx = gy * gridWidth + gx;
                        const strength = Math.max(10, this.maxPheromoneStrength - this.distanceTraveled * 0.3);
                        if (this.hasFood) {
                            // Returning: leave food trail so others can find the food
                            foodPheromones[idx] = Math.min(foodPheromones[idx] + strength, 255);
                        } else {
                            // Searching: leave home trail so we can find our way back
                            const distToColony = Math.sqrt((this.x - colony.x) ** 2 + (this.y - colony.y) ** 2);
                            const homeStrength = Math.max(20, PHEROMONE_DEPOSIT * 1.5 - distToColony * 0.2);
                            homePheromones[idx] = Math.min(homePheromones[idx] + homeStrength, 255);
                        }
                    }
                }

                if (this.hasFood) {
                    // ===== RETURNING STATE: Go directly to colony =====
                    const dx = colony.x - this.x;
                    const dy = colony.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    // Reached colony - drop food
                    if (dist < colony.radius + 5) {
                        this.hasFood = false;
                        this.foodColor = null; // Clear the food color
                        colony.foodStored++;
                        // Turn around to go search again
                        this.angle += Math.PI + (Math.random() - 0.5) * 1.0;
                        this.distanceTraveled = 0;
                        this.maxPheromoneStrength = PHEROMONE_DEPOSIT;
                    } else {
                        // Head towards colony with slight wandering for natural movement
                        const targetAngle = Math.atan2(dy, dx);
                        let angleDiff = targetAngle - this.angle;
                        while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                        while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                        
                        // Strong homing - turn towards colony
                        this.angle += angleDiff * 0.2;
                        
                        // Add tiny bit of wander for natural look
                        this.angle += (Math.random() - 0.5) * 0.1;
                    }
                } else {
                    // ===== SEARCHING STATE: Look for food using pheromones =====
                    
                    // Check for food first
                    for (let food of foods) {
                        const dx = food.x - this.x;
                        const dy = food.y - this.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < food.radius * 0.7 && food.amount > 0) {
                            // Found food! Pick it up and switch to RETURNING state
                            this.hasFood = true;
                            this.foodColor = food.color; // Store the food's color
                            food.amount--;
                            // Point towards colony
                            this.angle = Math.atan2(colony.y - this.y, colony.x - this.x);
                            this.distanceTraveled = 0;
                            this.maxPheromoneStrength = PHEROMONE_DEPOSIT;
                            break;
                        }
                    }
                    
                    // If didn't find food, follow food pheromones or wander
                    if (!this.hasFood) {
                        const senseAngle = Math.PI / 4;
                        const senseDistance = 12;

                        const leftStrength = this.sensePheromone(foodPheromones, this.angle - senseAngle, senseDistance);
                        const centerStrength = this.sensePheromone(foodPheromones, this.angle, senseDistance);
                        const rightStrength = this.sensePheromone(foodPheromones, this.angle + senseAngle, senseDistance);

                        const maxStrength = Math.max(leftStrength, centerStrength, rightStrength);

                        if (maxStrength > 2) {
                            // Follow food pheromones
                            if (centerStrength >= leftStrength && centerStrength >= rightStrength) {
                                this.wanderAngle += (Math.random() - 0.5) * WANDER_STRENGTH * 0.5;
                            } else if (leftStrength > rightStrength) {
                                this.wanderAngle -= PHEROMONE_FOLLOW_STRENGTH;
                            } else {
                                this.wanderAngle += PHEROMONE_FOLLOW_STRENGTH;
                            }
                        } else {
                            // No pheromones - random exploration
                            this.wanderAngle += (Math.random() - 0.5) * WANDER_STRENGTH * 2;
                        }

                        this.wanderAngle *= 0.9;
                        this.angle += this.wanderAngle * 0.1;
                    }
                }

                // Move
                const speed = ANT_SPEED;
                this.x += Math.cos(this.angle) * speed;
                this.y += Math.sin(this.angle) * speed;
                this.distanceTraveled += speed;

                // Bounce off walls
                const margin = 8;
                if (this.x < margin) { 
                    this.x = margin; 
                    this.angle = Math.PI - this.angle + (Math.random() - 0.5) * 0.5;
                    this.wanderAngle = 0;
                }
                if (this.x > width - margin) { 
                    this.x = width - margin; 
                    this.angle = Math.PI - this.angle + (Math.random() - 0.5) * 0.5;
                    this.wanderAngle = 0;
                }
                if (this.y < margin) { 
                    this.y = margin; 
                    this.angle = -this.angle + (Math.random() - 0.5) * 0.5;
                    this.wanderAngle = 0;
                }
                if (this.y > height - margin) { 
                    this.y = height - margin; 
                    this.angle = -this.angle + (Math.random() - 0.5) * 0.5;
                    this.wanderAngle = 0;
                }
            }

            sensePheromone(pheromones, angle, distance) {
                let total = 0;
                for (let d = 4; d <= distance; d += 4) {
                    const sx = this.x + Math.cos(angle) * d;
                    const sy = this.y + Math.sin(angle) * d;
                    const gx = Math.floor(sx / CELL_SIZE);
                    const gy = Math.floor(sy / CELL_SIZE);
                    if (gx >= 0 && gx < gridWidth && gy >= 0 && gy < gridHeight) {
                        total += pheromones[gy * gridWidth + gx];
                    }
                }
                return total;
            }

            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                
                if (antStyle === 'classic') {
                    // Classic simple ant - brown colored
                    ctx.fillStyle = '#5c4033';
                    
                    // Body (single oval)
                    ctx.beginPath();
                    ctx.ellipse(0, 0, 5, 3, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Head
                    ctx.beginPath();
                    ctx.arc(5, 0, 2, 0, Math.PI * 2);
                    ctx.fill();

                    // Food being carried
                    if (this.hasFood) {
                        ctx.fillStyle = this.foodColor || '#4ade80';
                        ctx.beginPath();
                        ctx.arc(-5, 0, 2.5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else {
                    // Detailed termite-style - darker brown
                    const antColor = '#3d2817';
                    
                    // Legs
                    ctx.strokeStyle = antColor;
                    ctx.lineWidth = 0.8;
                    const legWiggle = Math.sin(this.distanceTraveled * 0.5) * 0.2;
                    
                    // 3 pairs of legs
                    for (let i = -1; i <= 1; i++) {
                        const legX = i * 2;
                        const wiggle = (i === 0) ? 0 : legWiggle * i;
                        
                        // Left leg
                        ctx.beginPath();
                        ctx.moveTo(legX, 0);
                        ctx.lineTo(legX - 3, -3 + wiggle);
                        ctx.stroke();
                        
                        // Right leg
                        ctx.beginPath();
                        ctx.moveTo(legX, 0);
                        ctx.lineTo(legX - 3, 3 - wiggle);
                        ctx.stroke();
                    }
                    
                    ctx.fillStyle = antColor;
                    
                    // Abdomen (back)
                    ctx.beginPath();
                    ctx.ellipse(-3, 0, 3, 2.2, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Thorax (middle)
                    ctx.beginPath();
                    ctx.ellipse(1, 0, 2, 1.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Head
                    ctx.beginPath();
                    ctx.ellipse(4, 0, 1.8, 1.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Antennae
                    ctx.strokeStyle = antColor;
                    ctx.lineWidth = 0.5;
                    ctx.beginPath();
                    ctx.moveTo(5, -0.5);
                    ctx.quadraticCurveTo(7, -2, 8, -1);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(5, 0.5);
                    ctx.quadraticCurveTo(7, 2, 8, 1);
                    ctx.stroke();

                    // Food being carried
                    if (this.hasFood) {
                        const foodCol = this.foodColor || '#4ade80';
                        ctx.fillStyle = foodCol;
                        ctx.beginPath();
                        ctx.arc(-6, 0, 2.5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                
                ctx.restore();
            }
        }

        function createFood(x, y) {
            // Random number of sides (3-8) for organic shapes
            const sides = 3 + Math.floor(Math.random() * 6);
            const baseRadius = 12 + Math.random() * 12;
            
            // Generate irregular polygon vertices
            const vertices = [];
            for (let i = 0; i < sides; i++) {
                const angle = (i / sides) * Math.PI * 2 - Math.PI / 2;
                // Randomize radius for each vertex for organic look
                const r = baseRadius * (0.7 + Math.random() * 0.6);
                vertices.push({
                    x: Math.cos(angle) * r,
                    y: Math.sin(angle) * r
                });
            }
            
            // Random food color variations (different food types)
            const foodTypes = [
                { color: '#4ade80', highlight: '#86efac', name: 'leaf' },      // Green leaf
                { color: '#fbbf24', highlight: '#fcd34d', name: 'seed' },      // Yellow seed
                { color: '#f87171', highlight: '#fca5a5', name: 'berry' },     // Red berry
                { color: '#a78bfa', highlight: '#c4b5fd', name: 'flower' },    // Purple flower
                { color: '#fb923c', highlight: '#fdba74', name: 'crumb' },     // Orange crumb
            ];
            const foodType = foodTypes[Math.floor(Math.random() * foodTypes.length)];
            
            foods.push({
                x: x,
                y: y,
                radius: baseRadius,
                vertices: vertices,
                sides: sides,
                amount: 20 + Math.floor(Math.random() * 40),
                maxAmount: 60,
                color: foodType.color,
                highlight: foodType.highlight,
                rotation: Math.random() * Math.PI * 2
            });
        }

        function spawnRandomFood() {
            const margin = 80;
            let x, y;
            let attempts = 0;
            do {
                x = margin + Math.random() * (width - margin * 2);
                y = margin + Math.random() * (height - margin * 2);
                attempts++;
            } while (Math.sqrt((x - colony.x) ** 2 + (y - colony.y) ** 2) < 100 && attempts < 20);
            
            createFood(x, y);
        }

        function init() {
            resize();
            
            // Create initial ants
            ants = [];
            for (let i = 0; i < targetAntCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * colony.radius;
                ants.push(new Ant(
                    colony.x + Math.cos(angle) * dist,
                    colony.y + Math.sin(angle) * dist
                ));
            }

            // Create initial food sources
            foods = [];
            for (let i = 0; i < targetFoodCount; i++) {
                spawnRandomFood();
            }

            colony.foodStored = 0;
            
            // Generate colony dirt granules once
            colonyGranules = [];
            const hillRadius = colony.radius * 1.8;
            for (let i = 0; i < 30; i++) {
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * hillRadius * 0.8;
                colonyGranules.push({
                    x: Math.cos(angle) * dist,
                    y: Math.sin(angle) * dist * 0.7 - 5,
                    size: 1 + Math.random() * 2,
                    color: `rgba(${100 + Math.floor(Math.random() * 60)}, ${70 + Math.floor(Math.random() * 40)}, ${40 + Math.floor(Math.random() * 30)}, 0.5)`
                });
            }
        }

        function updatePheromones() {
            // Decay and diffuse pheromones
            const newHome = new Float32Array(gridWidth * gridHeight);
            const newFood = new Float32Array(gridWidth * gridHeight);

            // Home pheromones decay slower to maintain trails back to colony
            const HOME_DECAY = 0.998;
            const FOOD_DECAY = 0.994;

            for (let y = 0; y < gridHeight; y++) {
                for (let x = 0; x < gridWidth; x++) {
                    const idx = y * gridWidth + x;
                    
                    // Get neighbors for diffusion
                    let homeSum = homePheromones[idx] * (1 - PHEROMONE_DIFFUSE);
                    let foodSum = foodPheromones[idx] * (1 - PHEROMONE_DIFFUSE);

                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            if (dx === 0 && dy === 0) continue;
                            const nx = x + dx;
                            const ny = y + dy;
                            if (nx >= 0 && nx < gridWidth && ny >= 0 && ny < gridHeight) {
                                const nidx = ny * gridWidth + nx;
                                homeSum += homePheromones[nidx] * PHEROMONE_DIFFUSE / 8;
                                foodSum += foodPheromones[nidx] * PHEROMONE_DIFFUSE / 8;
                            }
                        }
                    }

                    newHome[idx] = homeSum * HOME_DECAY;
                    newFood[idx] = foodSum * FOOD_DECAY;
                }
            }

            homePheromones = newHome;
            foodPheromones = newFood;
        }

        function drawPheromones() {
            pheromoneCtx.clearRect(0, 0, width, height);
            
            if (!showTrails) return;

            const imageData = pheromoneCtx.createImageData(width, height);
            const data = imageData.data;

            for (let gy = 0; gy < gridHeight; gy++) {
                for (let gx = 0; gx < gridWidth; gx++) {
                    const idx = gy * gridWidth + gx;
                    const home = homePheromones[idx];
                    const food = foodPheromones[idx];

                    if (home > 1 || food > 1) {
                        // Draw cell
                        for (let py = 0; py < CELL_SIZE; py++) {
                            for (let px = 0; px < CELL_SIZE; px++) {
                                const pixelX = gx * CELL_SIZE + px;
                                const pixelY = gy * CELL_SIZE + py;
                                const pixelIdx = (pixelY * width + pixelX) * 4;

                                // Home pheromone: blue
                                // Food pheromone: orange/yellow (changed from green)
                                const homeAlpha = Math.min(home / 100, 1) * 0.6;
                                const foodAlpha = Math.min(food / 100, 1) * 0.6;

                                data[pixelIdx] = Math.floor(77 * homeAlpha + 255 * foodAlpha);     // R
                                data[pixelIdx + 1] = Math.floor(166 * homeAlpha + 180 * foodAlpha); // G
                                data[pixelIdx + 2] = Math.floor(255 * homeAlpha + 50 * foodAlpha);  // B
                                data[pixelIdx + 3] = Math.floor((homeAlpha + foodAlpha) * 180);     // A
                            }
                        }
                    }
                }
            }

            pheromoneCtx.putImageData(imageData, 0, 0);
        }

        function drawAnts() {
            antCtx.clearRect(0, 0, width, height);

            // Draw colony as ant hill mound with entrance hole
            const hillRadius = colony.radius * 1.8;
            
            // Outer dirt mound - multiple layers for 3D effect
            for (let i = 5; i >= 0; i--) {
                const layerRadius = hillRadius * (0.5 + i * 0.1);
                const layerOffset = i * 2;
                
                const gradient = antCtx.createRadialGradient(
                    colony.x, colony.y - layerOffset, 0,
                    colony.x, colony.y - layerOffset, layerRadius
                );
                
                // Sandy/dirt colors
                const brightness = 0.6 + i * 0.05;
                gradient.addColorStop(0, `rgba(${Math.floor(180 * brightness)}, ${Math.floor(140 * brightness)}, ${Math.floor(100 * brightness)}, ${0.9 - i * 0.1})`);
                gradient.addColorStop(0.6, `rgba(${Math.floor(140 * brightness)}, ${Math.floor(100 * brightness)}, ${Math.floor(70 * brightness)}, ${0.7 - i * 0.1})`);
                gradient.addColorStop(1, `rgba(100, 70, 50, 0)`);
                
                antCtx.fillStyle = gradient;
                antCtx.beginPath();
                antCtx.arc(colony.x, colony.y - layerOffset, layerRadius, 0, Math.PI * 2);
                antCtx.fill();
            }
            
            // Add some dirt texture/granules on the mound (use stored positions)
            for (let granule of colonyGranules) {
                antCtx.fillStyle = granule.color;
                antCtx.beginPath();
                antCtx.arc(colony.x + granule.x, colony.y + granule.y, granule.size, 0, Math.PI * 2);
                antCtx.fill();
            }
            
            // Dark entrance hole
            const holeGradient = antCtx.createRadialGradient(
                colony.x, colony.y, 0,
                colony.x, colony.y, colony.radius * 0.6
            );
            holeGradient.addColorStop(0, 'rgba(20, 15, 10, 1)');
            holeGradient.addColorStop(0.5, 'rgba(40, 30, 20, 0.95)');
            holeGradient.addColorStop(0.8, 'rgba(60, 45, 30, 0.8)');
            holeGradient.addColorStop(1, 'rgba(80, 60, 40, 0)');
            
            antCtx.fillStyle = holeGradient;
            antCtx.beginPath();
            antCtx.ellipse(colony.x, colony.y, colony.radius * 0.6, colony.radius * 0.45, 0, 0, Math.PI * 2);
            antCtx.fill();
            
            // Hole rim/edge highlight
            antCtx.strokeStyle = 'rgba(120, 90, 60, 0.6)';
            antCtx.lineWidth = 2;
            antCtx.beginPath();
            antCtx.ellipse(colony.x, colony.y, colony.radius * 0.6, colony.radius * 0.45, 0, 0, Math.PI * 2);
            antCtx.stroke();

            // Draw food sources with polygon shapes
            for (let food of foods) {
                if (food.amount > 0) {
                    const scale = 0.4 + (food.amount / food.maxAmount) * 0.6;
                    
                    antCtx.save();
                    antCtx.translate(food.x, food.y);
                    antCtx.rotate(food.rotation);
                    antCtx.scale(scale, scale);
                    
                    // Glow effect
                    const glowGradient = antCtx.createRadialGradient(0, 0, 0, 0, 0, food.radius * 1.5);
                    glowGradient.addColorStop(0, food.color + '40');
                    glowGradient.addColorStop(1, food.color + '00');
                    antCtx.fillStyle = glowGradient;
                    antCtx.beginPath();
                    antCtx.arc(0, 0, food.radius * 1.5, 0, Math.PI * 2);
                    antCtx.fill();
                    
                    // Main polygon shape
                    antCtx.fillStyle = food.color;
                    antCtx.beginPath();
                    antCtx.moveTo(food.vertices[0].x, food.vertices[0].y);
                    for (let i = 1; i < food.vertices.length; i++) {
                        antCtx.lineTo(food.vertices[i].x, food.vertices[i].y);
                    }
                    antCtx.closePath();
                    antCtx.fill();
                    
                    // Highlight
                    antCtx.fillStyle = food.highlight;
                    antCtx.beginPath();
                    const hx = food.vertices[0].x * 0.3;
                    const hy = food.vertices[0].y * 0.3 - 2;
                    antCtx.arc(hx, hy, food.radius * 0.25, 0, Math.PI * 2);
                    antCtx.fill();
                    
                    // Outline
                    antCtx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                    antCtx.lineWidth = 1;
                    antCtx.beginPath();
                    antCtx.moveTo(food.vertices[0].x, food.vertices[0].y);
                    for (let i = 1; i < food.vertices.length; i++) {
                        antCtx.lineTo(food.vertices[i].x, food.vertices[i].y);
                    }
                    antCtx.closePath();
                    antCtx.stroke();
                    
                    antCtx.restore();
                }
            }

            // Draw ants
            for (let ant of ants) {
                ant.draw(antCtx);
            }
        }

        function updateStats() {
            document.getElementById('ant-count').textContent = ants.length;
            document.getElementById('food-collected').textContent = colony.foodStored;
            document.getElementById('food-sources').textContent = foods.filter(f => f.amount > 0).length;
            document.getElementById('colony-size').textContent = Math.floor(1 + colony.foodStored / 50);
        }

        function update() {
            for (let i = 0; i < simulationSpeed; i++) {
                // Update ants
                for (let ant of ants) {
                    ant.update();
                }

                // Update pheromones
                updatePheromones();

                // Remove depleted food
                foods = foods.filter(f => f.amount > 0);

                // Manage food count based on slider
                while (foods.length < targetFoodCount) {
                    spawnRandomFood();
                }
                while (foods.length > targetFoodCount) {
                    foods.pop();
                }

                // Adjust ant count
                while (ants.length < targetAntCount) {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = Math.random() * colony.radius;
                    ants.push(new Ant(
                        colony.x + Math.cos(angle) * dist,
                        colony.y + Math.sin(angle) * dist
                    ));
                }
                while (ants.length > targetAntCount) {
                    ants.pop();
                }
            }
        }

        function render() {
            drawPheromones();
            drawAnts();
            updateStats();
        }

        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }

        // Event listeners
        // Click to add food
        antCanvas.addEventListener('click', (e) => {
            const rect = antCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            createFood(x, y);
        });

        // Touch support for mobile
        antCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const rect = antCanvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            createFood(x, y);
        });

        document.getElementById('ant-slider').addEventListener('input', (e) => {
            targetAntCount = parseInt(e.target.value);
        });

        document.getElementById('speed-slider').addEventListener('input', (e) => {
            simulationSpeed = parseInt(e.target.value);
        });

        document.getElementById('food-slider').addEventListener('input', (e) => {
            targetFoodCount = parseInt(e.target.value);
        });

        document.getElementById('toggle-trails').addEventListener('click', (e) => {
            showTrails = !showTrails;
            e.target.textContent = showTrails ? 'On' : 'Off';
            e.target.classList.toggle('active', showTrails);
        });

        document.getElementById('toggle-style').addEventListener('click', (e) => {
            antStyle = antStyle === 'classic' ? 'detailed' : 'classic';
            e.target.textContent = antStyle === 'classic' ? 'Ant' : 'Termite';
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            homePheromones.fill(0);
            foodPheromones.fill(0);
            init();
        });

        window.addEventListener('resize', () => {
            resize();
            drawBackground();
        });

        // Start
        init();
        gameLoop();
    </script>
</body>
</html>
